<!DOCTYPE html>
<html lang="es">

<head>
  <title>Crea, Analiza y Comparte: ¡Únete a la Comunidad de Clash Strategic!</title>

  <!-- PWA -->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description"
    content="Únete a nuestra vibrante comunidad de Clash Royale, donde los estrategas comparten análisis de mazos, trucos, torneos y más. ¡Domina el juego con nosotros hoy mismo!">
  <meta name="keywords"
    content="clash strategic, clash royale, comunidad clash royale, estrategia clash royale, analizar mazos clash royale, crear mazos clash royale, trucos clash royale, torneos clash royale, jugadores clash royale, comunidad de estrategas clash royale, juegos móviles clash royale, supercell, cartas clash royale, ver cofres clash royale, mejorar en clash royale">
  <meta name="author" content="Clash Strategic - Únete a nuestra comunidad en clashstrategic.com">

  <link rel="icon" type="image/png" sizes="512x512" href="./Frontend/static/media/styles/logo/logo_cs.webp">

  <style>
    #img_logo_index {
      position: fixed;
      width: 12em;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
    }

    #div_lin_loading {
      position: fixed;
      background: transparent;
      border-radius: 5px;
      text-align: center;
      border: solid 1.5px #1B263B;
      top: 97%;
      left: 50%;
      width: 99%;
      height: 1em;
      transform: translate(-50%, 0%);
      z-index: 100;
    }

    #span_msg_load {
      color: #1B263B;
      position: absolute;
      width: 100%;
      top: -1.5em;
      left: 50%;
      transform: translate(-50%, 0%);
      z-index: 100;
    }

    #span_num_por {
      color: #F4F4F4;
      position: absolute;
      font-size: 1.25em;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 100;
    }

    #div_porcentage {
      position: absolute;
      background: #1B263B;
      border-radius: 5px;
      width: 0%;
      height: 1em;
      top: 50%;
      transform: translate(0%, -50%);
    }
  </style>
</head>

<body>
  <img id="img_logo_index" src="./Frontend/static/media/styles/logo/logo_banner.webp" alt="Clash Strategic">
  <!-- line de carga -->
  <div id="div_lin_loading">
    <span id="span_msg_load"></span>
    <span id="span_num_por"></span>
    <div id="div_porcentage"></div>
  </div>
</body>
<script>
  document.addEventListener('DOMContentLoaded', function () {

    function loadCS(progress, msg = 'Cargando Recursos...') {
      document.getElementById('span_msg_load').textContent = msg;
      document.getElementById('span_num_por').textContent = progress + '%';
      document.getElementById('div_porcentage').style.width = progress + '%';
    }

    if ('serviceWorker' in navigator) {
      loadCS(25, 'Iniciando...');
      window.addEventListener('load', () => {
        let updatePending = false;

        navigator.serviceWorker.register('sw.js', { scope: './' })
          .then(reg => {
            console.log('SW registrado con éxito:', reg);
            loadCS(50, 'Cacheando Recursos...');

            // Si ya hay uno esperando, activarlo inmediatamente
            if (reg.waiting) {
              updatePending = true;
              activateUpdate(reg.waiting);
            }

            // Detectar uno nuevo en instalación
            reg.addEventListener('updatefound', () => {
              const newWorker = reg.installing;
              if (newWorker) {
                newWorker.addEventListener('statechange', () => {
                  if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                    updatePending = true;
                    activateUpdate(newWorker);
                  }
                });
              }
            });

            // Escuchar mensajes del SW
            navigator.serviceWorker.addEventListener('message', event => {
              const data = event.data;
              if (!data) return;

              if (data.type === 'progress') loadCS(data.progress, data.msg);
              if (data.type === 'CACHE_COMPLETE') loadCS(100, 'Cache Completado');
              if (data.type === 'ACTIVATED') console.log('SW activado');
              if (data.type === 'CACHE_FAILED') loadCS(100, 'Error: ' + data.msg);
              if (data.type === 'UPDATE_FAILED') loadCS(100, 'Error actualización: ' + data.msg);
            });

            // Redirigir si no hay actualización pendiente
            if (!updatePending) {
              loadCS(100, 'Listo');
              setTimeout(() => {
                return
              }, 500);
            }
          })
          .catch(err => {
            console.error('Error al registrar SW:', err);
            loadCS(50, 'Error al registrar el Service Worker');
          });

        // Forzar activación del nuevo SW
        function activateUpdate(worker) {
          console.log('Nueva versión detectada, activando...');
          worker.postMessage({ type: 'SKIP_WAITING' });

          // Esperar a que esté activado y recargar
          worker.addEventListener('statechange', () => {
            if (worker.state === 'activated') {
              console.log('Nueva versión activada');
              return
              location.reload();
            }
          });
        }

        // PWA install events
        window.addEventListener('beforeinstallprompt', e => e.preventDefault());
        window.addEventListener('appinstalled', () => console.log('PWA instalada'));
      });
    } else {
      alert('Este navegador no soporta PWA. Usa otro navegador o actualízalo.');
    }
  });
</script>

</html>